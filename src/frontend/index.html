<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>AI Recruiter Agent</title>
  </head>
  <body>
    <h2>Auth</h2>
    <div id="authSection">
      <input id="username" placeholder="username" />
      <input id="password" placeholder="password" type="password" />
      <button onclick="signup()">Signup</button>
      <button onclick="login()">Login</button>
    </div>
    <div id="userSection" style="display:none;">
      <p>Logged in as: <span id="userName"></span> (<span id="userId"></span>) <button onclick="logout()">Logout</button></p>
    </div>

    <h2>Connections</h2>
    <div>
      <button onclick="initiate('gmail')">Initiate Gmail</button>
      <button onclick="initiate('docs')">Initiate Google Docs</button>
    </div>

    <div>
      <p>Gmail Status: <span id="gmailStatus">Not connected</span></p>
      <p>Google Docs Status: <span id="docsStatus">Not connected</span></p>
    </div>

    <h2>Resume Processing</h2>
    <div>
      <input type="file" id="resumeFile" accept=".pdf"/>
      <button onclick="uploadResume()">Upload & Process</button>
    </div>

    <pre id="out"></pre>

    <script>
      const out = (msg) => {
        const el = document.getElementById('out');
        el.textContent = (el.textContent + '\n' + msg).trim();
      };
      const userIdEl = document.getElementById('userId');
      const userNameEl = document.getElementById('userName');
      const authSection = document.getElementById('authSection');
      const userSection = document.getElementById('userSection');
      let userId = localStorage.getItem('user_id') || '';
      let username = localStorage.getItem('username') || '';

      function setAuthUI() {
        if (userId) {
          authSection.style.display = 'none';
          userSection.style.display = '';
          userIdEl.textContent = userId;
          userNameEl.textContent = username;
          refreshStatuses();
        } else {
          authSection.style.display = '';
          userSection.style.display = 'none';
          document.getElementById('gmailStatus').textContent = 'Not connected';
          document.getElementById('docsStatus').textContent = 'Not connected';
        }
      }

      async function signup() {
        const inputUsername = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        const r = await fetch('/auth/signup', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username: inputUsername, password })});
        const j = await r.json();
        if (j.user_id) { userId = j.user_id; username = inputUsername; localStorage.setItem('user_id', userId); localStorage.setItem('username', username); setAuthUI(); }
        out(JSON.stringify(j));
      }

      async function login() {
        const inputUsername = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        const r = await fetch('/auth/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username: inputUsername, password })});
        const j = await r.json();
        if (j.user_id) { userId = j.user_id; username = j.username || inputUsername; localStorage.setItem('user_id', userId); localStorage.setItem('username', username); setAuthUI(); }
        out(JSON.stringify(j));
      }

      async function logout() {
        localStorage.removeItem('user_id');
        localStorage.removeItem('username');
        userId = '';
        username = '';
        setAuthUI();
        await refreshStatuses();
      }

      async function initiate(provider) {
        if (!userId) return out('No user_id');
        const r = await fetch(`/users/${userId}/connections/initiate`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ provider })});
        const j = await r.json();
        if (j.redirect_url) {
          window.open(j.redirect_url, '_blank');
          out(`Opened ${provider} auth window. Polling for completion...`);
          finalizeConnection(provider); 
        }
        out(JSON.stringify(j));
      }
      
      async function finalizeConnection(provider) {
        if (!userId) return;

        const statusEl = document.getElementById(provider + 'Status');
        statusEl.textContent = 'Finalizing... (this may take a moment)';

        try {
            const r = await fetch(`/users/${userId}/connections/finalize-latest`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ provider })
            });

            const j = await r.json();

            if (r.ok && j.ok) {
                statusEl.textContent = 'Connected ✓';
                out(`${provider} connection successful! ID: ${j.connection_id}`);
            } else {
                statusEl.textContent = 'Failed ✗';
                out(`${provider} connection failed: ${j.error || 'Unknown error'}`);
            }
            refreshStatuses();
        } catch (err) {
            statusEl.textContent = 'Failed ✗';
            out(`Error finalizing ${provider} connection: ${err.message}`);
        }
    }

      async function uploadResume() {
        if (!userId) return out("No user logged in");
        const fileInput = document.getElementById('resumeFile');
        if (!fileInput.files.length) {
          return alert('Please select a file first')
        }
        const formData = new FormData();
        formData.append("resume", fileInput.files[0]);
        try {
          const r = await fetch(`/users/${userId}/resume`, {
            method: 'POST',
            body: formData
          });
          const j = await r.json();
          out(JSON.stringify(j));
        }
        catch (err) {
          out(`Error uploading resume: ${err.message}`);
        }
      }
      async function refreshStatuses() {
        if (!userId) return;
        try {
          const r = await fetch(`/users/${userId}/connections/status`);
          const s = await r.json();
          document.getElementById('gmailStatus').textContent = s.gmail ? 'Connected ✓' : 'Not connected';
          document.getElementById('docsStatus').textContent = s.docs ? 'Connected ✓' : 'Not connected';
        } catch (e) {
          out('Failed to fetch connection statuses');
        }
      }
      
      // Initialize UI on load
      setAuthUI();
    </script>
  </body>
  </html>


